<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Beverage Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        /* Custom slider thumb and track colors for different preference sections */
        .slider-thumb-blue::-webkit-slider-thumb { background-color: #3b82f6; } /* Blue for hydration */
        .slider-thumb-blue::-moz-range-thumb { background-color: #3b82f6; }
        .slider-track-blue { background-color: #dbeafe; }

        .slider-thumb-red::-webkit-slider-thumb { background-color: #ef4444; } /* Red for women's preferences */
        .slider-thumb-red::-moz-range-thumb { background-color: #ef4444; }
        .slider-track-red { background-color: #fee2e2; }

        .slider-thumb-yellow::-webkit-slider-thumb { background-color: #eab308; } /* Yellow for men's preferences */
        .slider-thumb-yellow::-moz-range-thumb { background-color: #eab308; }
        .slider-track-yellow { background-color: #fef9c3; }

        /* General slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Chart container for responsive sizing */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Default height */
            max-height: 400px; /* Max height for charts */
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px; /* Adjust height for medium screens */
            }
        }
        
        /* Styling for details/summary (accordion for shopping list explanations) */
        details > summary {
            list-style: none; /* Remove default marker */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Remove default marker for webkit browsers */
        }

        /* Active state for tab buttons */
        .tab-button.active {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">Interactive Wedding Beverage Calculator</h1>
            <p class="text-slate-600 mt-2">Customize your wedding details to get accurate beverage and cost estimations.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Left Column: Controls (1/3 width on large screens) -->
            <aside class="lg:w-1/3 w-full bg-white p-6 rounded-2xl shadow-lg flex-shrink-0">
                <div class="space-y-6">
                    <!-- Guest Demographics Input Section -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">1. Guest Demographics</h3>
                        <div class="space-y-3">
                            <label class="block">
                                <span class="text-sm font-medium">Women (Alcohol Drinkers)</span>
                                <input type="number" id="womenDrinkers" value="10" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium">Women (Non-Drinkers)</span>
                                <input type="number" id="womenNonDrinkers" value="4" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium">Men (Alcohol Drinkers)</span>
                                <input type="number" id="menDrinkers" value="11" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium">Men (Non-Drinkers)</span>
                                <input type="number" id="menNonDrinkers" value="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                        </div>
                    </div>

                    <!-- Core Assumptions Input Section -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">2. Core Assumptions</h3>
                        <div class="space-y-3">
                            <label class="block">
                                <span class="text-sm font-medium">Drinks per Person per Hour</span>
                                <input type="number" step="0.1" id="drinksPerHour" value="0.5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                            <label class="block">
                                <span class="text-sm font-medium">Hydration (ml per 8h)</span>
                                <input type="number" step="50" id="hydrationRate" value="800" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                             <label class="block">
                                <span class="text-sm font-medium">Ice per Guest per 24h (grams)</span>
                                <input type="number" step="10" id="icePerGuest" value="680" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                             <label class="block">
                                <span class="text-sm font-medium">Additional Ice for Buckets (kg)</span>
                                <input type="number" step="1" id="extraIceBuckets" value="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </label>
                        </div>
                    </div>
                    
                    <!-- Hydration Preferences Input Section -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">3. Hydration Preferences</h3>
                        <div id="hydration-preferences" class="space-y-3"></div>
                    </div>

                    <!-- Event Timeline Input Section -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">4. Event Phases</h3>
                        <div id="event-phases" class="space-y-4"></div>
                        <button id="add-phase-btn" class="mt-4 w-full bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-md transition-colors">+ Add New Phase</button>
                    </div>

                    <!-- Beverage Preferences per Phase Input Section -->
                    <div>
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">5. Beverage Preferences per Phase</h3>
                        <div id="phase-preferences" class="space-y-6"></div>
                    </div>

                    <!-- Shots Calculator Section (Moved from Tab to Left Column) -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold border-b pb-2 mb-4">6. Shots Calculator</h3>
                        <p class="text-sm text-slate-500 mb-4">Estimate liquor, salt, and lime needed for shots rounds.</p>
                        <div class="grid md:grid-cols-1 gap-6">
                            <!-- Whiskey Shots -->
                            <div class="p-3 border rounded-md bg-slate-50">
                                <h4 class="font-bold text-md mb-2">Whiskey Shots</h4>
                                <label class="block mb-2">
                                    <span class="text-sm font-medium">Participants:</span>
                                    <input type="number" id="whiskeyShotParticipants" value="6" min="0" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </label>
                                <label class="block">
                                    <span class="text-sm font-medium">Number of Rounds:</span>
                                    <input type="number" id="whiskeyShotRounds" value="5" min="0" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </label>
                            </div>
                            <!-- Tequila Shots -->
                            <div class="p-3 border rounded-md bg-slate-50">
                                <h4 class="font-bold text-md mb-2">Tequila Shots</h4>
                                <label class="block mb-2">
                                    <span class="text-sm font-medium">Participants:</span>
                                    <input type="number" id="tequilaShotParticipants" value="6" min="0" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </label>
                                <label class="block">
                                    <span class="text-sm font-medium">Number of Rounds:</span>
                                    <input type="number" id="tequilaShotRounds" value="3" min="0" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right Column: Dashboard (2/3 width on large screens) -->
            <main class="lg:w-2/3 w-full space-y-8">
                <!-- Tab Navigation for Dashboard, Cocktail Calculator, and FAQ -->
                <div class="flex justify-center mb-4">
                    <button id="dashboard-tab-btn" class="tab-button active px-6 py-3 rounded-l-lg font-semibold bg-slate-100 hover:bg-slate-200 transition-colors">Dashboard</button>
                    <button id="cocktail-calculator-tab-btn" class="tab-button px-6 py-3 font-semibold bg-slate-100 hover:bg-slate-200 transition-colors">Cocktail Calculator</button>
                    <button id="faq-tab-btn" class="tab-button px-6 py-3 rounded-r-lg font-semibold bg-slate-100 hover:bg-slate-200 transition-colors">FAQ</button>
                </div>

                <!-- Dashboard Section Content -->
                <div id="dashboard-section" class="space-y-8">
                    <!-- Dashboard Introduction Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Results Dashboard</h2>
                        <p class="text-slate-600">This section dynamically reflects your choices. Here you'll find event timeline visualizations, a summary of beverage needs, estimated cocktail servings, ice requirements, and a detailed shopping list with costs. Each element is interactive to help you understand and optimize your planning.</p>
                    </div>
                    
                    <!-- Event Timeline and Estimated Cocktail Servings side-by-side -->
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Event Timeline Visualization Card -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4">Event Timeline</h3>
                            <p class="text-sm text-slate-500 mb-4">This visualization shows the individual phases of your wedding and their duration. Use this timeline to ensure your schedule is balanced and that you have planned beverages appropriately for each stage of the celebration.</p>
                            <div id="timeline-visualization" class="space-y-3"></div>
                        </div>

                        <!-- Estimated Cocktail Servings Chart -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4">Estimated Cocktail Servings</h3>
                            <p class="text-sm text-slate-500 mb-4">This chart displays the predicted number of servings for each cocktail type that will be served throughout the entire event. Use it to adjust your cocktail menu to guest preferences and ensure the popularity of selected drinks.</p>
                            <div class="chart-container h-[300px] md:h-auto"><canvas id="cocktailServingsChart"></canvas></div>
                            <button id="get-cocktail-ideas-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">✨ Get Cocktail Ideas</button>
                            <div id="cocktail-ideas-output" class="mt-4 p-3 bg-slate-100 rounded-md text-sm hidden"></div>
                        </div>
                    </div>

                    <!-- Shopping List & Cost Estimate Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-2">Shopping List & Cost Estimate</h3>
                         <p class="text-sm text-slate-500 mb-4">This is your final, consolidated shopping list. It includes all necessary beverages and ingredients, their required quantities, estimated unit prices, and total cost. Click on any item to see a detailed explanation of how its quantity was calculated.</p>
                        <div class="flex justify-between items-center mb-4 bg-slate-100 p-4 rounded-lg">
                            <span class="text-lg font-bold">Total Estimated Cost:</span>
                            <span id="totalCost" class="text-2xl font-bold text-blue-600">0.00 PLN</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Product</th>
                                        <th scope="col" class="px-6 py-3 text-right">Quantity</th>
                                        <th scope="col" class="px-6 py-3 text-right">Volume</th>
                                        <th scope="col" class="px-6 py-3 text-right">Cost (PLN)</th>
                                    </tr>
                                </thead>
                                <tbody id="shopping-list">
                                    <!-- Items will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button id="get-shopping-tips-btn" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">✨ Get Shopping Tips</button>
                        <div id="shopping-tips-output" class="mt-4 p-3 bg-slate-100 rounded-md text-sm hidden"></div>
                    </div>

                    <!-- Ice Calculation Card -->
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold mb-4">Ice Requirements</h3>
                        <p class="text-sm text-slate-500 mb-4">Below is the total estimated amount of ice needed for your event, including ice for drinks, cocktails, and an additional reserve for chilling bottles. Ensure you have enough to keep beverages at the perfect temperature throughout the night.</p>
                        <div class="flex items-center justify-center text-center mt-4">
                            <div>
                                <div id="totalIce" class="text-6xl font-bold text-blue-600">0 kg</div>
                                <div class="text-slate-500 mt-2">Total Estimated Ice</div>
                                <div id="iceBreakdown" class="text-xs text-slate-400 mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cocktail Calculator Section Content -->
                <div id="cocktail-calculator-section" class="bg-white p-6 rounded-2xl shadow-lg hidden">
                    <h3 class="text-xl font-semibold mb-4">Custom Cocktail Ingredient Calculator</h3>
                    <p class="text-sm text-slate-500 mb-4">Calculate ingredients for a specific cocktail based on custom guest and drink counts. This tool uses the internal recipe data for precise estimations.</p>
                    <div class="space-y-3 mb-4">
                        <label class="block">
                            <span class="text-sm font-medium">Select Cocktail:</span>
                            <select id="customCocktailSelect" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <!-- Options populated by JS -->
                            </select>
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium">Custom Guest Count:</span>
                            <input type="number" id="customCocktailGuestCount" value="10" min="1" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium">Drinks per Guest (of this cocktail):</span>
                            <input type="number" step="0.1" id="customCocktailDrinksPerGuest" value="1" min="0.1" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </label>
                    </div>
                    <button id="calculateCustomCocktailBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Calculate Custom Cocktail Ingredients</button>
                    <div id="custom-cocktail-output" class="mt-4 p-3 bg-slate-100 rounded-md text-sm hidden"></div>
                </div>

                <!-- FAQ Section Content -->
                <div id="faq-section" class="bg-white p-6 rounded-2xl shadow-lg hidden">
                    <h2 class="text-2xl font-bold text-slate-900 mb-4">Frequently Asked Questions & Assumptions</h2>
                    <p class="text-slate-600 mb-6">This section summarizes the core assumptions and data points used in the calculations. Understanding these helps you interpret the results and make informed adjustments.</p>
                    <div id="faq-content" class="space-y-4">
                        <!-- FAQ content will be populated by JS -->
                    </div>
                </div>
            </main>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // Initial data for the calculator, including guest counts, assumptions,
    // hydration preferences, event phases, beverage preferences, recipes,
    // servings per bottle, and prices.
    const initialData = {
        guests: {
            womenDrinkers: 10,
            womenNonDrinkers: 4,
            menDrinkers: 11,
            menNonDrinkers: 3,
        },
        assumptions: {
            drinksPerHour: 0.5,
            hydrationRate: 800, // ml per 8 hours
            icePerGuest: 680, // grams per 24h
            extraIceBuckets: 5, // kg
        },
        hydrationPreferences: [
            { name: "Water", percent: 30, color: '#3b82f6' },
            { name: "Coca Cola", percent: 30, color: '#ef4444' },
            { name: "Ginger Ale", percent: 20, color: '#eab308' },
            { name: "Soda", percent: 20, color: '#64748b' }
        ],
        eventPhases: [
            { id: 1, name: "Friday Reception", start: "17:00", end: "02:00" }, 
            { id: 2, name: "Saturday Grill", start: "11:35", end: "17:00" }, 
            { id: 3, name: "Saturday Party", start: "17:00", end: "02:00" }, 
        ],
        beverages: {
            women: ["Prosecco", "White Wine", "Mojito", "Aperol Spritz", "Hugo", "Beer"],
            men: ["White Wine", "Whiskey and Cola", "Mojito", "Aperol Spritz", "Hugo", "Beer"],
            nonDrinkers: ["Non-alcoholic beer", "Non-alcoholic Prosecco"] // Non-drinker options
        },
        preferences: {
            1: { // Friday Reception
                women: { "Prosecco": 25, "White Wine": 0, "Mojito": 25, "Aperol Spritz": 25, "Hugo": 25, "Beer": 0 },
                men: { "White Wine": 0, "Whiskey and Cola": 70, "Mojito": 15, "Beer": 15, "Aperol Spritz": 0, "Hugo": 0 },
                nonDrinkers: { "Non-alcoholic beer": 50, "Non-alcoholic Prosecco": 50 }
            },
            2: { // Saturday Grill
                women: { "Prosecco": 0, "White Wine": 0, "Mojito": 33, "Aperol Spritz": 21, "Hugo": 9, "Beer": 37 },
                men: { "White Wine": 0, "Whiskey and Cola": 10, "Mojito": 20, "Beer": 70, "Aperol Spritz": 0, "Hugo": 0 },
                nonDrinkers: { "Non-alcoholic beer": 60, "Non-alcoholic Prosecco": 40 }
            },
            3: { // Saturday Party
                women: { "Prosecco": 35, "White Wine": 0, "Mojito": 20, "Aperol Spritz": 25, "Hugo": 10, "Beer": 10 },
                men: { "White Wine": 5, "Whiskey and Cola": 60, "Mojito": 15, "Beer": 15, "Hugo": 5 },
                nonDrinkers: { "Non-alcoholic beer": 40, "Non-alcoholic Prosecco": 60 }
            }
        },
        recipes: {
            "Aperol Spritz": [
                { item: "Prosecco", qty: 90, unit: "ml" },
                { item: "Aperol", qty: 60, unit: "ml" },
                { item: "Soda", qty: 30, unit: "ml" },
                { item: "Oranges", qty: 0.2, unit: "unit" }
            ],
            "Hugo": [
                { item: "Prosecco", qty: 150, unit: "ml" },
                { item: "Elderflower Liqueur", qty: 20, unit: "ml" },
                { item: "Tonic Water", qty: 90, unit: "ml" },
                { item: "Limes", qty: 0.2, unit: "unit" },
                { item: "Mint", qty: 4, unit: "leaves" }
            ],
            "Mojito": [
                { item: "White Rum", qty: 60, unit: "ml" },
                { item: "Soda", qty: 125, unit: "ml" },
                { item: "Limes", qty: 0.5, unit: "unit" },
                { item: "Mint", qty: 10, unit: "leaves" },
                { item: "Sugar", qty: 15, unit: "g" }
            ],
            "Whiskey and Cola": [
                { item: "Whiskey", qty: 50, unit: "ml" },
                { item: "Coca Cola", qty: 100, unit: "ml" }
            ]
        },
        shots: { // New section for shot calculations
            whiskey: { participants: 6, rounds: 5 }, // Updated default values
            tequila: { participants: 6, rounds: 3 } // Updated default values
        },
        servingsPerBottle: {
            "Prosecco": { size: 750, servings: 5 },
            "Non-alcoholic Prosecco": { size: 750, servings: 5 },
            "Whiskey": { size: 750, servings: 15 }, // Updated for 50ml shots
            "Tequila": { size: 750, servings: 15 }, // Updated for 50ml shots
            "Beer": { size: 500, servings: 1 },
            "Non-alcoholic beer": { size: 500, servings: 1 },
            "Aperol": { size: 1000, servings: 17 },
            "Coca Cola": { size: 2000, servings: 12 },
            "Ginger Ale": { size: 2000, servings: 12 },
            "Soda": { size: 2000, servings: 67 },
            "White Rum": { size: 750, servings: 17 },
            "Water": { size: 1000, servings: 2.5 },
            "Elderflower Liqueur": { size: 700, servings: 35 },
            "White Wine": { size: 750, servings: 5 },
            "Tonic Water": { size: 1000, servings: 4 }
        },
        prices: {
            "Prosecco": 44.99,
            "Non-alcoholic Prosecco": 29.99,
            "White Wine": 29.99,
            "Whiskey": 79.99, // 750ml
            "Tequila": 89.99, // Example price for 750ml
            "Beer": 3.99, // 500ml
            "Non-alcoholic beer": 3.50,
            "Aperol": 69.99, // 1000ml
            "White Rum": 76.99, // 750ml
            "Elderflower Liqueur": 150.00, // 700ml
            "Water": 1.99, // 1000ml
            "Coca Cola": 8.99, // 2000ml
            "Ginger Ale": 7.99, // 2000ml
            "Soda": 2.49, // 2000ml
            "Tonic Water": 2.49, // 2000ml (for Hugo)
            "Limes": 1.50, // unit
            "Oranges": 2.00, // unit
            "Mint": 4.99, // bunch (approx. 50 leaves)
            "Sugar": 5.99, // kg
            "Salt": 4.00 // Example price per kg
        }
    };

    // Deep copy initial data to state to allow modifications
    let state = JSON.parse(JSON.stringify(initialData));
    let nextPhaseId = 4; // Counter for new event phases
    let currentShoppingList = {}; // To store the latest shopping list for LLM prompt

    // --- UI RENDER FUNCTIONS ---

    /**
     * Renders all input sections and updates calculations.
     */
    function renderAll() {
        renderGuestInputs();
        renderAssumptionInputs();
        renderHydrationPreferences();
        renderEventPhases();
        renderPhasePreferences();
        renderShotInputs(); // Now called from here as it's part of the main input column
        populateCustomCocktailSelect(); // Populate custom cocktail dropdown
        renderFAQ(); // Render FAQ content
        updateAllCalculations();
    }
    
    /**
     * Renders the guest demographic input fields with current state values.
     */
    function renderGuestInputs() {
        document.getElementById('womenDrinkers').value = state.guests.womenDrinkers;
        document.getElementById('womenNonDrinkers').value = state.guests.womenNonDrinkers;
        document.getElementById('menDrinkers').value = state.guests.menDrinkers;
        document.getElementById('menNonDrinkers').value = state.guests.menNonDrinkers;
    }

    /**
     * Renders the core assumptions input fields with current state values.
     */
    function renderAssumptionInputs() {
        document.getElementById('drinksPerHour').value = state.assumptions.drinksPerHour;
        document.getElementById('hydrationRate').value = state.assumptions.hydrationRate;
        document.getElementById('icePerGuest').value = state.assumptions.icePerGuest;
        document.getElementById('extraIceBuckets').value = state.assumptions.extraIceBuckets;
    }

    /**
     * Renders the hydration preference sliders and labels.
     * Adjusts other slider values to maintain a total of 100%.
     */
    function renderHydrationPreferences() {
        const container = document.getElementById('hydration-preferences');
        container.innerHTML = '';
        state.hydrationPreferences.forEach(pref => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="flex justify-between items-center">
                    <span class="text-sm font-medium">${pref.name}</span>
                    <span class="text-sm font-bold text-blue-600">${pref.percent}%</span>
                </label>
                <input type="range" min="0" max="100" value="${pref.percent}" data-name="${pref.name}" class="mt-1 slider-track-blue slider-thumb-blue">
            `;
            container.appendChild(div);
        });
    }

    /**
     * Renders the event phase input fields (name, start/end times).
     */
    function renderEventPhases() {
        const container = document.getElementById('event-phases');
        container.innerHTML = '';
        state.eventPhases.forEach(phase => {
            const div = document.createElement('div');
            div.className = 'p-3 border rounded-md bg-slate-50';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <input type="text" value="${phase.name}" data-id="${phase.id}" class="font-semibold bg-transparent border-0 p-0 focus:ring-0 w-full" placeholder="Phase Name">
                    <button class="remove-phase-btn text-red-500 hover:text-red-700 text-xl font-bold" data-id="${phase.id}">&times;</button>
                </div>
                <div class="flex gap-2 mt-2">
                    <input type="time" value="${phase.start}" data-id="${phase.id}" data-type="start" class="block w-full text-sm rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <input type="time" value="${phase.end}" data-id="${phase.id}" data-type="end" class="block w-full text-sm rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
            `;
            container.appendChild(div);
        });
    }

    /**
     * Renders the beverage preference sliders for each event phase and gender.
     * Adjusts other slider values to maintain a total of 100% within each group.
     * Also includes the new consumption multiplier.
     */
    function renderPhasePreferences() {
        const container = document.getElementById('phase-preferences');
        container.innerHTML = '';
        state.eventPhases.forEach(phase => {
            const phasePrefs = state.preferences[phase.id] || { women: {}, men: {}, nonDrinkers: {} };
            const div = document.createElement('div');
            div.className = 'p-4 border rounded-lg';
            div.innerHTML = `
                <h4 class="font-bold text-md mb-3">${phase.name}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm font-semibold mb-2">Women</p>
                        <div class="space-y-2" data-phase-id="${phase.id}" data-gender="women">
                            ${Object.entries(phasePrefs.women).map(([bev, pct]) => `
                                <div>
                                    <label class="flex justify-between items-center text-xs"><span>${bev}</span><span class="font-bold">${pct}%</span></label>
                                    <input type="range" min="0" max="100" value="${pct}" data-beverage="${bev}" class="slider-track-red slider-thumb-red">
                                </div>`).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-semibold mb-2">Men</p>
                        <div class="space-y-2" data-phase-id="${phase.id}" data-gender="men">
                           ${Object.entries(phasePrefs.men).map(([bev, pct]) => `
                                <div>
                                    <label class="flex justify-between items-center text-xs"><span>${bev}</span><span class="font-bold">${pct}%</span></label>
                                    <input type="range" min="0" max="100" value="${pct}" data-beverage="${bev}" class="slider-track-yellow slider-thumb-yellow">
                                </div>`).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="text-sm font-semibold mb-2">Non-Drinkers</p>
                        <div class="space-y-2" data-phase-id="${phase.id}" data-gender="nonDrinkers">
                           ${Object.entries(phasePrefs.nonDrinkers).map(([bev, pct]) => `
                                <div>
                                    <label class="flex justify-between items-center text-xs"><span>${bev}</span><span class="font-bold">${pct}%</span></label>
                                    <input type="range" min="0" max="100" value="${pct}" data-beverage="${bev}" class="slider-track-blue slider-thumb-blue">
                                </div>`).join('')}
                        </div>
                    </div>
                </div>
                <!-- Removed Consumption Multiplier (%) -->
            `;
            container.appendChild(div);
        });
    }

    /**
     * Renders the shot input fields with current state values.
     */
    function renderShotInputs() {
        // These inputs are now directly in the HTML, so we just set their values
        document.getElementById('whiskeyShotParticipants').value = state.shots.whiskey.participants;
        document.getElementById('whiskeyShotRounds').value = state.shots.whiskey.rounds;
        document.getElementById('tequilaShotParticipants').value = state.shots.tequila.participants;
        document.getElementById('tequilaShotRounds').value = state.shots.tequila.rounds;
    }

    /**
     * Populates the custom cocktail select dropdown with available cocktail recipes.
     */
    function populateCustomCocktailSelect() {
        const select = document.getElementById('customCocktailSelect');
        if (!select) return; 
        select.innerHTML = ''; 
        Object.keys(state.recipes).forEach(cocktailName => {
            const option = document.createElement('option');
            option.value = cocktailName;
            option.textContent = cocktailName;
            select.appendChild(option);
        });
    }

    /**
     * Renders the FAQ content dynamically based on initial data assumptions.
     */
    function renderFAQ() {
        const faqContent = document.getElementById('faq-content');
        faqContent.innerHTML = `
            <h4 class="text-lg font-semibold text-slate-800">Guest Demographics:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li>Women (Alcohol Drinkers): ${initialData.guests.womenDrinkers}</li>
                <li>Women (Non-Drinkers): ${initialData.guests.nonDrinkers}</li>
                <li>Men (Alcohol Drinkers): ${initialData.guests.menDrinkers}</li>
                <li>Men (Non-Drinkers): ${initialData.guests.menNonDrinkers}</li>
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Core Assumptions:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li>Drinks per Person per Hour: ${initialData.assumptions.drinksPerHour}</li>
                <li>Hydration: ${initialData.assumptions.hydrationRate} ml per person every 8 hours</li>
                <li>Ice per Guest per 24h: ${initialData.assumptions.icePerGuest} grams</li>
                <li>Additional Ice for Buckets: ${initialData.assumptions.extraIceBuckets} kg</li>
                <li>Prosecco Toast Serving Size: 150 ml per guest</li>
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Hydration Preferences (Entire Event):</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                ${initialData.hydrationPreferences.map(pref => `<li>${pref.name}: ${pref.percent}%</li>`).join('')}
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Event Timeline Phases:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                ${initialData.eventPhases.map(phase => `<li>${phase.name}: Start ${phase.start}, End ${phase.end}</li>`).join('')}
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Servings Per Bottle/Unit:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                ${Object.entries(initialData.servingsPerBottle).map(([item, data]) => `<li>${item}: ${data.servings} servings per ${data.size} ml</li>`).join('')}
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Cocktail Recipes (Quantity per Serving):</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                ${Object.entries(initialData.recipes).map(([cocktail, ingredients]) => `
                    <li>
                        <strong>${cocktail}:</strong>
                        <ul class="list-circle list-inside ml-4">
                            ${ingredients.map(ing => `<li>${ing.item}: ${ing.qty} ${ing.unit}</li>`).join('')}
                        </ul>
                    </li>
                `).join('')}
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Reference Prices (PLN):</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                ${Object.entries(initialData.prices).map(([item, price]) => `<li>${item}: ${price.toFixed(2)}</li>`).join('')}
            </ul>

            <h4 class="text-lg font-semibold text-slate-800 mt-4">Shots Assumptions:</h4>
            <ul class="list-disc list-inside ml-4 space-y-1">
                <li>Standard Shot Size: 50ml</li>
                <li>Salt per Tequila Shot: 1 gram</li>
                <li>Lime per Tequila Shot: 0.25 units (equivalent to a quarter of a lime)</li>
            </ul>
        `;
    }


    // --- EVENT HANDLERS ---

    // Universal event listener for input changes to update state and calculations
    document.body.addEventListener('input', (e) => {
        // Handle Guest Inputs
        if(['womenDrinkers', 'womenNonDrinkers', 'menDrinkers', 'menNonDrinkers'].includes(e.target.id)) {
            state.guests[e.target.id] = parseInt(e.target.value) || 0;
        }
        // Handle Assumption Inputs
        if(['drinksPerHour', 'hydrationRate', 'icePerGuest', 'extraIceBuckets'].includes(e.target.id)) {
            state.assumptions[e.target.id] = parseFloat(e.target.value) || 0;
        }
        // Handle Hydration Preferences sliders
        if(e.target.parentElement.parentElement.id === 'hydration-preferences') {
            const name = e.target.dataset.name;
            const newValue = parseInt(e.target.value);
            const targetPref = state.hydrationPreferences.find(p => p.name === name);
            const others = state.hydrationPreferences.filter(p => p.name !== name);
            
            targetPref.percent = newValue;
            const newTotalForOthers = 100 - newValue;
            
            let totalOfOthers = others.reduce((sum, p) => sum + p.percent, 0);
            if (totalOfOthers === 0) { // Distribute evenly if all others were 0
                others.forEach(p => p.percent = newTotalForOthers / others.length);
            } else { // Distribute proportionally
                others.forEach(p => p.percent = Math.round(p.percent / totalOfOthers * newTotalForOthers));
            }
            
            // Adjust to ensure total is exactly 100 (due to rounding)
            let currentTotal = state.hydrationPreferences.reduce((sum, p) => sum + p.percent, 0);
            if (currentTotal !== 100 && others.length > 0) {
                others[0].percent += (100 - currentTotal);
            }

            renderHydrationPreferences(); // Re-render to show updated percentages
        }

        // Handle Event Phase Inputs (Name, Time)
        if (e.target.dataset.id && e.target.closest('#event-phases')) {
            const id = parseInt(e.target.dataset.id);
            const phase = state.eventPhases.find(p => p.id === id);
            if (e.target.type === 'text') {
                phase.name = e.target.value;
                renderPhasePreferences(); // Re-render phase preferences to update phase names
            } else if (e.target.type === 'time') {
                phase[e.target.dataset.type] = e.target.value;
            }
        }
        
        // Handle Beverage Preferences Sliders (per phase, per gender)
        const prefContainer = e.target.closest('[data-phase-id]');
        if(prefContainer) {
            const phaseId = parseInt(prefContainer.dataset.phaseId);
            const gender = prefContainer.dataset.gender; // 'women', 'men', or 'nonDrinkers'
            const beverage = e.target.dataset.beverage;
            const newValue = parseInt(e.target.value);

            const prefs = state.preferences[phaseId][gender];
            const otherSliders = Array.from(prefContainer.querySelectorAll(`[data-gender="${gender}"] input[type="range"]:not([data-beverage="${beverage}"])`));
            
            prefs[beverage] = newValue;

            let totalOfOthers = otherSliders.reduce((sum, slider) => sum + prefs[slider.dataset.beverage], 0);
            const newTotalForOthers = 100 - newValue;

            if (totalOfOthers === 0) { // Distribute evenly if all others were 0
                otherSliders.forEach(slider => {
                    prefs[slider.dataset.beverage] = Math.floor(newTotalForOthers / otherSliders.length);
                });
            } else { // Distribute proportionally
                others.forEach(slider => {
                    prefs[slider.dataset.beverage] = Math.round((prefs[slider.dataset.beverage] / totalOfOthers) * newTotalForOthers);
                });
            }
            
            // Adjust to ensure total is exactly 100 (due to rounding)
            let currentTotal = Object.values(prefs).reduce((sum, val) => sum + val, 0);
             if (currentTotal !== 100 && otherSliders.length > 0) {
                 prefs[otherSliders[0].dataset.beverage] += (100 - currentTotal);
            }

            renderPhasePreferences(); // Re-render to show updated percentages
        }

        // Handle Shot Inputs
        if (e.target.id === 'whiskeyShotParticipants') state.shots.whiskey.participants = parseInt(e.target.value) || 0;
        if (e.target.id === 'whiskeyShotRounds') state.shots.whiskey.rounds = parseInt(e.target.value) || 0;
        if (e.target.id === 'tequilaShotParticipants') state.shots.tequila.participants = parseInt(e.target.value) || 0;
        if (e.target.id === 'tequilaShotRounds') state.shots.tequila.rounds = parseInt(e.target.value) || 0;


        updateAllCalculations(); // Recalculate everything on any input change
    });
    
    // Event listener for adding a new event phase
    document.getElementById('add-phase-btn').addEventListener('click', () => {
        const newPhase = { id: nextPhaseId, name: `New Phase ${nextPhaseId-3}`, start: "20:00", end: "23:00" }; 
        state.eventPhases.push(newPhase);
        // Initialize default preferences for the new phase
        state.preferences[nextPhaseId] = {
            women: Object.fromEntries(state.beverages.women.map((bev, i) => [bev, i === 0 ? 100 : 0])),
            men: Object.fromEntries(state.beverages.men.map((bev, i) => [bev, i === 1 ? 100 : 0])),
            nonDrinkers: Object.fromEntries(state.beverages.nonDrinkers.map((bev, i) => [bev, i === 0 ? 100 : 0])),
        };
        nextPhaseId++;
        renderEventPhases();
        renderPhasePreferences();
        updateAllCalculations();
    });
    
    // Event listener for removing an event phase
    document.body.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-phase-btn')) {
            const id = parseInt(e.target.dataset.id);
            state.eventPhases = state.eventPhases.filter(p => p.id !== id);
            delete state.preferences[id]; // Remove associated preferences
            renderEventPhases();
            renderPhasePreferences();
            updateAllCalculations();
        }
    });

    // Tab switching logic for Dashboard, Cocktail Calculator, and FAQ sections
    // Removed shots-calculator-tab-btn logic as it's no longer a separate tab
    document.getElementById('dashboard-tab-btn').addEventListener('click', () => {
        document.getElementById('dashboard-section').classList.remove('hidden');
        document.getElementById('cocktail-calculator-section').classList.add('hidden');
        document.getElementById('faq-section').classList.add('hidden');
        
        document.getElementById('dashboard-tab-btn').classList.add('active');
        document.getElementById('cocktail-calculator-tab-btn').classList.remove('active');
        document.getElementById('faq-tab-btn').classList.remove('active');
    });

    document.getElementById('cocktail-calculator-tab-btn').addEventListener('click', () => {
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('cocktail-calculator-section').classList.remove('hidden');
        document.getElementById('faq-section').classList.add('hidden');
        
        document.getElementById('dashboard-tab-btn').classList.remove('active');
        document.getElementById('cocktail-calculator-tab-btn').classList.add('active');
        document.getElementById('faq-tab-btn').classList.remove('active');
    });

    document.getElementById('faq-tab-btn').addEventListener('click', () => {
        document.getElementById('dashboard-section').classList.add('hidden');
        document.getElementById('cocktail-calculator-section').classList.add('hidden');
        document.getElementById('faq-section').classList.remove('hidden');
        
        document.getElementById('dashboard-tab-btn').classList.remove('active');
        document.getElementById('cocktail-calculator-tab-btn').classList.remove('active');
        document.getElementById('faq-tab-btn').classList.add('active');
    });


    // --- CALCULATION LOGIC ---

    /**
     * Calculates the duration of an event phase in hours.
     * Handles cases where the end time is on the next day.
     * @param {string} start - Start time in "HH:MM" format.
     * @param {string} end - End time in "HH:MM" format.
     * @returns {number} Duration in hours.
     */
    function getDuration(start, end) {
        const startDate = new Date(`1970-01-01T${start}:00`);
        let endDate = new Date(`1970-01-01T${end}:00`);
        // If end time is earlier than start time, assume it's the next day
        if (endDate < startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }
        return (endDate - startDate) / (1000 * 60 * 60); // Convert milliseconds to hours
    }

    /**
     * Performs all calculations based on the current state and updates the dashboard.
     */
    function updateAllCalculations() {
        // Calculate total guest counts
        const womenDrinkers = state.guests.womenDrinkers;
        const menDrinkers = state.guests.menDrinkers;
        const totalDrinkers = womenDrinkers + menDrinkers;
        const womenNonDrinkers = state.guests.womenNonDrinkers;
        const menNonDrinkers = state.guests.menNonDrinkers;
        const totalNonDrinkers = womenNonDrinkers + menNonDrinkers;
        const totalGuests = totalDrinkers + totalNonDrinkers;
        
        let shoppingList = {}; // Stores aggregated items and their total amounts
        let explanationList = {}; // Stores calculation formulas for each item

        /**
         * Adds an item to the shopping list, aggregating amounts and storing explanations.
         * @param {string} item - The name of the product.
         * @param {number} amount - The quantity to add.
         * @param {string} unit - The unit of the quantity (e.g., 'L', 'kg').
         * @param {string} formula - The explanation for how the amount was calculated.
         */
        function addToShoppingList(item, amount, unit, formula) {
            if (!shoppingList[item]) {
                shoppingList[item] = { amount: 0, unit: unit };
                explanationList[item] = [];
            }
            shoppingList[item].amount += amount;
            shoppingList[item].unit = unit; // Ensure unit is correctly set/updated
            explanationList[item].push(formula);
        }

        // 1. Calculate quantities for toasts (Prosecco and Non-alcoholic Prosecco)
        const toastServingSize = 0.150; // 150ml per toast
        addToShoppingList("Prosecco", totalDrinkers * toastServingSize, 'L', `Toast for drinkers: ${totalDrinkers} guests * 150ml = ${ (totalDrinkers * toastServingSize).toFixed(2) } L`);
        addToShoppingList("Non-alcoholic Prosecco", totalNonDrinkers * toastServingSize, 'L', `Toast for non-drinkers: ${totalNonDrinkers} guests * 150ml = ${ (totalNonDrinkers * toastServingSize).toFixed(2) } L`);
        
        // 2. Calculate quantities for hydration beverages
        const totalEventDuration = state.eventPhases.reduce((sum, phase) => sum + getDuration(phase.start, phase.end), 0);
        const hydrationPerGuest = state.assumptions.hydrationRate / 1000 * (totalEventDuration / 8); // Liters per guest for whole event
        const totalHydration = totalGuests * hydrationPerGuest;
        
        state.hydrationPreferences.forEach(pref => {
            const amount = totalHydration * (pref.percent / 100);
            addToShoppingList(pref.name, amount, 'L', `Hydration (${pref.name}): ${totalGuests} guests * ${hydrationPerGuest.toFixed(2)}L/guest * ${pref.percent}% = ${amount.toFixed(2)} L`);
        });

        // 3. Calculate quantities for alcoholic and non-alcoholic drinks based on phase preferences
        let cocktailServings = {}; // To track total servings for each cocktail

        state.eventPhases.forEach(phase => {
            const duration = getDuration(phase.start, phase.end);
            const drinksPerPersonPerHour = state.assumptions.drinksPerHour;
            
            const phasePrefs = state.preferences[phase.id];
            if (!phasePrefs) return; // Skip if no preferences for this phase (e.g., newly added phase without default prefs)

            // Women (Alcoholic Drinkers) beverage calculations
            Object.entries(phasePrefs.women).forEach(([bev, pct]) => {
                if (pct > 0) {
                    const totalServings = womenDrinkers * drinksPerPersonPerHour * duration * (pct / 100); 
                    const formula = `${phase.name} (Women - ${bev}): ${womenDrinkers} guests * ${drinksPerPersonPerHour.toFixed(2)} drinks/h * ${duration.toFixed(1)}h * ${pct}% = ${totalServings.toFixed(2)} servings`;
                    if (state.recipes[bev]) { // If it's a cocktail, add to cocktail servings
                        if (!cocktailServings[bev]) cocktailServings[bev] = 0;
                        cocktailServings[bev] += totalServings;
                    } else { // It's a simple beverage, calculate based on servings per bottle
                        // Corrected: Calculate serving volume per drink, not bottle size
                        const servingVolumePerDrink = (state.servingsPerBottle[bev]?.size / (state.servingsPerBottle[bev]?.servings || 1)) / 1000; // in Liters, default to 1 serving if not specified to prevent division by zero
                        addToShoppingList(bev, totalServings * servingVolumePerDrink, 'L', formula);
                    }
                }
            });

            // Men (Alcoholic Drinkers) beverage calculations
            Object.entries(phasePrefs.men).forEach(([bev, pct]) => {
                 if (pct > 0) {
                    const totalServings = menDrinkers * drinksPerPersonPerHour * duration * (pct / 100); 
                    const formula = `${phase.name} (Men - ${bev}): ${menDrinkers} guests * ${drinksPerPersonPerHour.toFixed(2)} drinks/h * ${duration.toFixed(1)}h * ${pct}% = ${totalServings.toFixed(2)} servings`;
                    if (state.recipes[bev]) {
                        if (!cocktailServings[bev]) cocktailServings[bev] = 0;
                        cocktailServings[bev] += totalServings;
                    } else {
                        // Corrected: Calculate serving volume per drink, not bottle size
                        const servingVolumePerDrink = (state.servingsPerBottle[bev]?.size / (state.servingsPerBottle[bev]?.servings || 1)) / 1000; // in Liters
                        addToShoppingList(bev, totalServings * servingVolumePerDrink, 'L', formula);
                    }
                }
            });

            // Non-Drinkers beverage calculations (Non-alcoholic beer, Non-alcoholic Prosecco)
            Object.entries(phasePrefs.nonDrinkers).forEach(([bev, pct]) => {
                if (pct > 0) {
                    const totalServings = totalNonDrinkers * drinksPerPersonPerHour * duration * (pct / 100); 
                    const formula = `${phase.name} (Non-Drinkers - ${bev}): ${totalNonDrinkers} guests * ${drinksPerPersonPerHour.toFixed(2)} drinks/h * ${duration.toFixed(1)}h * ${pct}% = ${totalServings.toFixed(2)} servings`;
                    // Corrected: Calculate serving volume per drink, not bottle size
                    const servingVolumePerDrink = (state.servingsPerBottle[bev]?.size / (state.servingsPerBottle[bev]?.servings || 1)) / 1000; // in Liters
                    addToShoppingList(bev, totalServings * servingVolumePerDrink, 'L', formula);
                }
            });
        });
        
        // 4. Calculate quantities for cocktail ingredients based on total cocktail servings
        Object.entries(cocktailServings).forEach(([cocktailName, totalServings]) => {
            state.recipes[cocktailName].forEach(ingredient => {
                let amount = ingredient.qty * totalServings;
                let unit = ingredient.unit;
                let formula = `Ingredient for ${cocktailName}: ${totalServings.toFixed(0)} servings * ${ingredient.qty} ${ingredient.unit} = `;
                
                // Convert to more practical units for shopping list
                if (ingredient.unit === 'ml') {
                    amount /= 1000; // Convert ml to Liters
                    unit = 'L';
                    formula += `${amount.toFixed(2)} L`;
                } else if(ingredient.unit === 'unit') {
                    unit = 'unit(s)';
                    formula += `${amount.toFixed(1)} unit(s)`;
                } else if(ingredient.unit === 'leaves') {
                    unit = 'bunches';
                    const leavesPerBunch = 50; // Assumption for mint leaves per bunch
                    amount /= leavesPerBunch;
                    formula += `${(ingredient.qty * totalServings).toFixed(0)} leaves / ${leavesPerBunch} leaves/bunch = ${amount.toFixed(2)} bunches`;
                } else { // Default to grams, convert to kg
                    amount /= 1000; // Convert g to kg
                    unit = 'kg';
                    formula += `${amount.toFixed(2)} kg`;
                }
                addToShoppingList(ingredient.item, amount, unit, formula);
            });
        });

        // 5. Calculate quantities for Shots
        const shotSizeMl = 50; // Standard shot size in ml

        // Whiskey Shots
        const totalWhiskeyShots = state.shots.whiskey.participants * state.shots.whiskey.rounds;
        if (totalWhiskeyShots > 0) {
            const whiskeyAmountL = (totalWhiskeyShots * shotSizeMl) / 1000;
            addToShoppingList("Whiskey", whiskeyAmountL, 'L', `Whiskey Shots: ${state.shots.whiskey.participants} participants * ${state.shots.whiskey.rounds} rounds * ${shotSizeMl}ml/shot = ${whiskeyAmountL.toFixed(2)} L`);
        }

        // Tequila Shots
        const totalTequilaShots = state.shots.tequila.participants * state.shots.tequila.rounds;
        if (totalTequilaShots > 0) {
            const tequilaAmountL = (totalTequilaShots * shotSizeMl) / 1000;
            addToShoppingList("Tequila", tequilaAmountL, 'L', `Tequila Shots: ${state.shots.tequila.participants} participants * ${state.shots.tequila.rounds} rounds * ${shotSizeMl}ml/shot = ${tequilaAmountL.toFixed(2)} L`);

            const saltPerShotG = 1; // 1 gram of salt per shot
            const totalSaltG = totalTequilaShots * saltPerShotG;
            addToShoppingList("Salt", totalSaltG / 1000, 'kg', `Salt for Tequila Shots: ${totalTequilaShots} shots * ${saltPerShotG}g/shot = ${(totalSaltG / 1000).toFixed(2)} kg`);

            const limePerShotUnit = 0.25; // 0.25 of a lime per shot (a quarter)
            const totalLimeUnits = totalTequilaShots * limePerShotUnit;
            addToShoppingList("Limes", totalLimeUnits, 'unit(s)', `Limes for Tequila Shots: ${totalTequilaShots} shots * ${limePerShotUnit} unit/shot = ${totalLimeUnits.toFixed(1)} unit(s)`);
        }
        
        // 6. Calculate total ice requirements
        const baseIce = (totalGuests * state.assumptions.icePerGuest / 1000) * (totalEventDuration/24); // Ice for guests based on duration
        const cocktailIceAllowance = 0.2; // 200g (0.2kg) per cocktail serving
        const totalCocktailServings = Object.values(cocktailServings).reduce((sum, servings) => sum + servings, 0);
        const cocktailIce = totalCocktailServings * cocktailIceAllowance;
        const totalIceKg = baseIce + cocktailIce + state.assumptions.extraIceBuckets;
        const iceFormula = `
            Ice for guests: ${totalGuests} guests * ${(state.assumptions.icePerGuest/1000).toFixed(2)}kg/day * (${(totalEventDuration/24).toFixed(2)} days) = ${baseIce.toFixed(2)} kg <br>
            Ice for cocktails: ${totalCocktailServings.toFixed(0)} servings * ${cocktailIceAllowance}kg/serving = ${cocktailIce.toFixed(2)} kg <br>
            Additional reserve for buckets: ${state.assumptions.extraIceBuckets} kg <br>
            <b>Total: ${totalIceKg.toFixed(2)} kg</b>
        `;
        addToShoppingList("Ice", totalIceKg, 'kg', iceFormula);
        document.getElementById('totalIce').textContent = `${totalIceKg.toFixed(1)} kg`;
        document.getElementById('iceBreakdown').innerHTML = `(Base: ${baseIce.toFixed(1)}kg, Cocktails: ${cocktailIce.toFixed(1)}kg, Reserve: ${state.assumptions.extraIceBuckets}kg)`;

        // Store the latest shopping list for LLM prompt
        currentShoppingList = JSON.parse(JSON.stringify(shoppingList));

        // Finalize Shopping List and update dashboard UI
        updateDashboard(shoppingList, explanationList, cocktailServings);
    }
    
    // --- DASHBOARD UPDATE ---

    /**
     * Updates the dashboard UI elements including timeline, charts, and shopping list.
     * @param {object} finalList - The aggregated shopping list with amounts.
     * @param {object} explanationList - Detailed explanations for each shopping list item.
     * @param {object} cocktailServings - Total servings calculated for each cocktail.
     */
    function updateDashboard(finalList, explanationList, cocktailServings) {
        // Update Event Timeline Visualization
        const timelineContainer = document.getElementById('timeline-visualization');
        timelineContainer.innerHTML = '';
        const totalDuration = state.eventPhases.reduce((sum, p) => sum + getDuration(p.start, p.end), 0);

        state.eventPhases.forEach((phase, index) => {
            const duration = getDuration(phase.start, phase.end);
            const widthPercentage = totalDuration > 0 ? (duration / totalDuration) * 100 : (100 / state.eventPhases.length); // Distribute evenly if totalDuration is 0
            const colorClass = ['bg-blue-400', 'bg-red-400', 'bg-yellow-400'][index % 3]; // Cycle through colors
            const div = document.createElement('div');
            div.className = 'w-full';
            div.innerHTML = `
                <div class="flex justify-between items-center text-sm mb-1">
                    <span class="font-semibold">${phase.name}</span>
                    <span class="text-slate-500">${duration.toFixed(1)}h</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-4">
                    <div class="${colorClass} h-4 rounded-full" style="width: ${widthPercentage}%"></div>
                </div>
            `;
            timelineContainer.appendChild(div);
        });

        let totalCost = 0;
        const shoppingListContainer = document.getElementById('shopping-list');
        shoppingListContainer.innerHTML = '';

        // Define categories for chart aggregation (still needed for shopping list calculations)
        const alcoholTypes = ["Prosecco", "White Wine", "Whiskey", "Tequila", "Beer", "Aperol", "White Rum", "Elderflower Liqueur"]; // Added Tequila
        const hydrationTypes = ["Water", "Coca Cola", "Ginger Ale", "Soda", "Tonic Water", "Non-alcoholic beer", "Non-alcoholic Prosecco"];
        const cocktailIngredients = ["Limes", "Oranges", "Mint", "Sugar", "Salt"]; // Added Salt

        // Populate shopping list table and aggregate data for charts
        Object.entries(finalList).forEach(([item, data]) => {
            let purchaseUnits = 0;
            let volumeDisplay = ''; // New variable for volume display
            let itemCost = 0;
            let price = state.prices[item] || 0; // Get price from state, default to 0 if not found
            
            // Determine purchase units, volume display, and cost based on item type and unit
            if (data.unit === 'L') {
                const bottleSize = (state.servingsPerBottle[item]?.size || 750); // Default to 750ml for liquor
                purchaseUnits = Math.ceil(data.amount / (bottleSize / 1000)); // Convert L to ml, then divide by bottle size in ml
                volumeDisplay = `${bottleSize}ml`;
                itemCost = purchaseUnits * price;
            } else if(data.unit === 'unit(s)') {
                purchaseUnits = Math.ceil(data.amount);
                volumeDisplay = `unit`;
                itemCost = purchaseUnits * price;
            } else if (data.unit === 'bunches') {
                purchaseUnits = Math.ceil(data.amount);
                volumeDisplay = `bunch`;
                itemCost = purchaseUnits * price;
            } else if (data.unit === 'kg') {
                purchaseUnits = Math.ceil(data.amount);
                if (item === "Ice") {
                    purchaseUnits = Math.ceil(data.amount / 5); // Assume 5kg bags for ice
                    volumeDisplay = `5kg`;
                    itemCost = purchaseUnits * 10; // Assume 10 PLN per 5kg bag of ice
                } else {
                    volumeDisplay = `1kg`; // Assuming 1kg bags for sugar, etc.
                    itemCost = purchaseUnits * price;
                }
            }
            totalCost += itemCost;
            
            // Create table rows for product details and expandable explanation
            const trProduct = document.createElement('tr');
            trProduct.className = "bg-white border-b hover:bg-slate-50";
            trProduct.innerHTML = `
                <td class="px-6 py-4 font-medium text-slate-900">${item}</td>
                <td class="px-6 py-4 text-right font-medium text-slate-900">${purchaseUnits}</td>
                <td class="px-6 py-4 text-right font-medium text-slate-900">${volumeDisplay}</td>
                <td class="px-6 py-4 text-right font-bold text-slate-900">${itemCost.toFixed(2)}</td>
            `;
            shoppingListContainer.appendChild(trProduct);

            const trDetails = document.createElement('tr');
            trDetails.className = "bg-white border-b hover:bg-slate-50";
            trDetails.innerHTML = `
                <td colspan="4" class="px-0 py-0">
                    <details>
                        <summary class="flex items-center cursor-pointer px-6 py-2 text-xs text-slate-500 hover:text-slate-700">
                            Click for calculation details
                        </summary>
                        <div class="p-4 bg-slate-100 text-xs">
                            <h5 class="font-bold mb-1">How we calculated this:</h5>
                            <ul class="list-disc list-inside space-y-1">${explanationList[item].map(ex => `<li>${ex}</li>`).join('')}</ul>
                        </div>
                    </details>
                </td>
            `;
            shoppingListContainer.appendChild(trDetails);
        });

        document.getElementById('totalCost').textContent = `${totalCost.toFixed(2)} PLN`;
        
        cocktailServingsChart.data.labels = Object.keys(cocktailServings);
        cocktailServingsChart.data.datasets[0].data = Object.values(cocktailServings);
        cocktailServingsChart.update();
    }

    // --- CHART SETUP ---

    // Set global font family for Chart.js
    Chart.defaults.font.family = "'Inter', sans-serif";
    // Common options for all charts
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false, // Allow charts to resize freely
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 20 }
            }
        }
    };

    // Initialize Estimated Cocktail Servings Bar Chart
    const cocktailServingsChart = new Chart(document.getElementById('cocktailServingsChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Estimated Servings',
                data: [],
                backgroundColor: ['#3b82f6', '#ef4444', '#eab308', '#84cc16', '#a855f7', '#14b8a6'], // Various colors for bars
                borderColor: 'rgba(255, 255, 255, 0)', // No border for bars
                borderWidth: 1
            }]
        },
        options: {
            ...commonOptions,
            indexAxis: 'y', // Horizontal bars
            scales: {
                x: { beginAtZero: true, grid: { display: false } }, // Hide x-axis grid lines
                y: { grid: { display: false } } // Hide y-axis grid lines
            },
            plugins: { legend: { display: false } } // Hide legend for bar chart
        }
    });

    // --- GEMINI API INTEGRATION ---

    /**
     * Calls the Gemini API with a given prompt and displays the response.
     * Handles loading states and errors.
     * @param {string} prompt - The text prompt to send to the LLM.
     * @param {string} type - The type of API call ('shoppingTips' or 'cocktailIdeas') to determine output div and button.
     */
    async function callGeminiAPI(prompt, type) {
        let outputDiv;
        let button;

        // Determine which output div and button to use based on the call type
        if (type === 'shoppingTips') {
            outputDiv = document.getElementById('shopping-tips-output');
            button = document.getElementById('get-shopping-tips-btn');
        } else if (type === 'cocktailIdeas') {
            outputDiv = document.getElementById('cocktail-ideas-output');
            button = document.getElementById('get-cocktail-ideas-btn');
        } else {
            console.error(`Error: Unknown Gemini API call type: ${type}`);
            return;
        }

        // Basic error handling for missing UI elements
        if (!outputDiv) {
            console.error(`Error: Output div for type "${type}" not found.`);
            return;
        }
        if (!button) {
            console.error(`Error: Button for type "${type}" not found.`);
            return;
        }

        // Show loading indicator and disable button
        outputDiv.classList.remove('hidden');
        outputDiv.innerHTML = '<div class="text-center text-slate-500">Loading...</div>';
        button.disabled = true;

        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // API key is automatically provided by Canvas runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            // Check if the response contains valid content
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                outputDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`; // Display the response, preserving newlines
            } else {
                outputDiv.innerHTML = '<p class="text-red-500">Error: Could not get a response from the AI.</p>';
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            outputDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        } finally {
            button.disabled = false; // Re-enable button
        }
    }

    // Event listener for "Get Cocktail Ideas" button
    document.getElementById('get-cocktail-ideas-btn').addEventListener('click', () => {
        // Format existing cocktail recipes for the prompt
        const currentCocktails = Object.keys(state.recipes).map(name => {
            const ingredients = state.recipes[name].map(ing => `${ing.qty}${ing.unit} ${ing.item}`).join(', ');
            return `${name} (${ingredients})`;
        }).join('; ');

        const prompt = `Given these cocktail recipes used in a wedding: ${currentCocktails}. Suggest 3-5 new, creative cocktail ideas that could be made using some of these ingredients, or similar common wedding bar ingredients (e.g., vodka, gin, tequila, rum, various juices, syrups, bitters). For each idea, provide a name, a brief description, and key ingredients. Format as a list.`;
        callGeminiAPI(prompt, 'cocktailIdeas');
    });

    // Event listener for "Get Shopping Tips" button
    document.getElementById('get-shopping-tips-btn').addEventListener('click', () => {
        // Format the current shopping list for the prompt
        const shoppingListText = Object.entries(currentShoppingList)
            .map(([item, data]) => `${item}: ${data.amount.toFixed(2)} ${data.unit}`)
            .join('; ');

        const prompt = `Considering this wedding beverage shopping list: ${shoppingListText}. Provide 3-5 practical tips for optimizing the shopping, such as where to buy certain items (e.g., bulk for water, specialty stores for liqueurs), common discounts to look for, or cost-saving alternatives for common items. Focus on general advice applicable to large events. Format as a list.`;
        callGeminiAPI(prompt, 'shoppingTips');
    });

    // Event listener for custom cocktail calculation (now uses internal logic)
    const calculateCustomCocktailBtn = document.getElementById('calculateCustomCocktailBtn');
    if (calculateCustomCocktailBtn) {
        calculateCustomCocktailBtn.addEventListener('click', () => {
            const selectedCocktailName = document.getElementById('customCocktailSelect').value;
            const customGuestCount = parseInt(document.getElementById('customCocktailGuestCount').value);
            const customDrinksPerGuest = parseFloat(document.getElementById('customCocktailDrinksPerGuest').value);
            const outputDiv = document.getElementById('custom-cocktail-output');
            const button = document.getElementById('calculateCustomCocktailBtn');

            // Input validation
            if (!selectedCocktailName || isNaN(customGuestCount) || customGuestCount <= 0 || isNaN(customDrinksPerGuest) || customDrinksPerGuest <= 0) {
                outputDiv.classList.remove('hidden');
                outputDiv.innerHTML = '<p class="text-red-500">Please select a cocktail and enter valid guest and drink counts.</p>';
                return;
            }

            // Show loading state
            outputDiv.classList.remove('hidden');
            outputDiv.innerHTML = '<div class="text-center text-slate-500">Calculating...</div>';
            button.disabled = true;

            try {
                const cocktailRecipe = state.recipes[selectedCocktailName];
                let calculatedIngredients = {};
                const totalServings = customGuestCount * customDrinksPerGuest;

                if (!cocktailRecipe) {
                    outputDiv.innerHTML = `<p class="text-red-500">Error: Recipe for "${selectedCocktailName}" not found.</p>`;
                    return;
                }

                // Calculate ingredients based on total servings
                cocktailRecipe.forEach(ingredient => {
                    let amount = ingredient.qty * totalServings;
                    let unit = ingredient.unit;
                    let displayUnit = unit;
                    let purchaseUnits = 0;
                    let purchaseUnitName = '';

                    // Convert units for display and determine purchase units
                    if (unit === 'ml') {
                        amount /= 1000; // Convert to Liters
                        displayUnit = 'L';
                        const bottleSize = (state.servingsPerBottle[ingredient.item]?.size || 1000) / 1000; // in Liters
                        purchaseUnits = Math.ceil(amount / bottleSize);
                        purchaseUnitName = `${purchaseUnits} x ${bottleSize * 1000}ml`;
                    } else if (unit === 'g') {
                        amount /= 1000; // Convert to kg
                        displayUnit = 'kg';
                        purchaseUnits = Math.ceil(amount); // Assuming 1kg bags for sugar, etc.
                        purchaseUnitName = `${purchaseUnits} kg`;
                    } else if (unit === 'leaves') {
                        const leavesPerBunch = 50; // Assumption for mint
                        purchaseUnits = Math.ceil(amount / leavesPerBunch);
                        displayUnit = 'leaves';
                        purchaseUnitName = `${purchaseUnits} bunch(es)`;
                    } else if (unit === 'unit') {
                        purchaseUnits = Math.ceil(amount);
                        displayUnit = 'unit(s)';
                        purchaseUnitName = `${purchaseUnits} unit(s)`;
                    }

                    calculatedIngredients[ingredient.item] = {
                        totalAmount: amount.toFixed(2),
                        displayUnit: displayUnit,
                        purchaseUnits: purchaseUnits,
                        purchaseUnitName: purchaseUnitName
                    };
                });

                // Display calculated ingredients
                let resultHtml = `<h4 class="font-bold mb-2">Ingredients for ${selectedCocktailName} (${totalServings.toFixed(0)} servings):</h4><ul>`;
                Object.entries(calculatedIngredients).forEach(([item, data]) => {
                    resultHtml += `<li><strong>${item}:</strong> ${data.totalAmount} ${data.displayUnit} (Purchase: ${data.purchaseUnitName})</li>`;
                });
                resultHtml += '</ul>';
                outputDiv.innerHTML = resultHtml;

            } catch (error) {
                console.error("Error calculating custom cocktail:", error);
                outputDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            } finally {
                button.disabled = false; // Re-enable button
            }
        });
    }


    // Initial load of all UI elements and calculations when the DOM is ready
    renderAll();
});
</script>
</body>
</html>
